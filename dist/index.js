"use strict";var C=Object.defineProperty;var b=(r,e,a)=>e in r?C(r,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):r[e]=a;var j=(r,e,a)=>b(r,typeof e!="symbol"?e+"":e,a);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("react/jsx-runtime"),o=require("react");class N{constructor(e,a){j(this,"baseUrl");j(this,"apiKey");this.baseUrl=e,this.apiKey=a}getHeaders(){const e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async initConversation(){const e=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!e.ok)throw new Error("Failed to initialize conversation");return(await e.json()).conversationId}async*streamMessage(e,a){const t=await fetch(`${this.baseUrl}/api/conversation/${e}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:a})});if(!t.ok)throw new Error("Failed to send message");if(!t.body)throw new Error("No response body");const i=t.body.getReader(),c=new TextDecoder;for(;;){const{done:u,value:n}=await i.read();if(u)break;const m=c.decode(n).split(`
`);for(const w of m)if(w.startsWith("data: ")){const f=w.slice(6);if(f==="[DONE]")return;try{yield JSON.parse(f).content||""}catch(v){console.error("Failed to parse chunk:",v)}}}}}function x(r,e){const[a,t]=o.useState([]),[i,c]=o.useState(!1),[u,n]=o.useState(null),d=o.useRef(null),m=o.useRef(new N(r,e)),w=o.useCallback(async()=>{try{const l=await m.current.initConversation();return d.current=l,l}catch(l){throw n(l),l}},[]),f=o.useCallback(async l=>{d.current||await w();const S={id:Date.now().toString(),role:"user",content:l,timestamp:new Date};t(p=>[...p,S]),c(!0),n(null);const _={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};t(p=>[...p,_]);try{const p=m.current.streamMessage(d.current,l);for await(const y of p)t(h=>h.map(g=>g.id===_.id?{...g,content:g.content+y}:g));t(y=>y.map(h=>h.id===_.id?{...h,isStreaming:!1}:h))}catch(p){n(p),t(y=>y.filter(h=>h.id!==_.id))}finally{c(!1)}},[w]),v=o.useCallback(()=>{t([]),d.current=null},[]);return{messages:a,isLoading:i,error:u,sendMessage:f,clearMessages:v}}function M({messages:r}){return s.jsx("div",{className:"chat-wrapper__messages",children:r.map(e=>s.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[s.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&s.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),s.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id))})}function k({onSend:r,disabled:e,placeholder:a}){const[t,i]=o.useState(""),c=()=>{t.trim()&&!e&&(r(t.trim()),i(""))},u=n=>{n.key==="Enter"&&!n.shiftKey&&(n.preventDefault(),c())};return s.jsxs("div",{className:"chat-wrapper__input",children:[s.jsx("textarea",{value:t,onChange:n=>i(n.target.value),onKeyPress:u,placeholder:a,disabled:e,className:"chat-wrapper__textarea",rows:1}),s.jsx("button",{onClick:c,disabled:e||!t.trim(),className:"chat-wrapper__send-button",children:"Send"})]})}function E({apiUrl:r,config:e}){const{messages:a,isLoading:t,error:i,sendMessage:c}=x(r,e.apiKey);o.useEffect(()=>{e.onError&&i&&e.onError(i)},[i,e]);const n=((...m)=>m.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${e.mode}`,e.position&&`chat-wrapper--${e.position}`,e.theme&&`chat-wrapper--${e.theme}`),d=()=>e.mode==="modal"?s.jsx("div",{className:"chat-wrapper-overlay"}):null;return s.jsxs(s.Fragment,{children:[d(),s.jsxs("div",{className:n,style:e.customStyles,children:[s.jsx("div",{className:"chat-wrapper__header",children:s.jsx("h2",{className:"chat-wrapper__title",children:e.appName})}),s.jsx(M,{messages:a}),s.jsx(k,{onSend:c,disabled:t,placeholder:e.placeholder||"Type a message..."}),i&&s.jsxs("div",{className:"chat-wrapper__error",children:["Error: ",i.message]})]})]})}exports.ChatWrapper=E;exports.useChatConnection=x;
