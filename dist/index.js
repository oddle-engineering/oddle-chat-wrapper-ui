"use strict";var C=Object.defineProperty;var N=(e,t,a)=>t in e?C(e,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):e[t]=a;var S=(e,t,a)=>N(e,typeof t!="symbol"?t+"":t,a);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const r=require("react/jsx-runtime"),o=require("react");class k{constructor(t,a){S(this,"baseUrl");S(this,"apiKey");this.baseUrl=t,this.apiKey=a}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,a){const s=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:a})});if(!s.ok)throw new Error("Failed to send message");if(!s.body)throw new Error("No response body");const n=s.body.getReader(),c=new TextDecoder;for(;;){const{done:h,value:i}=await n.read();if(h)break;const f=c.decode(i).split(`
`);for(const m of f)if(m.startsWith("data: ")){const y=m.slice(6);if(y==="[DONE]")return;try{yield JSON.parse(y).content||""}catch(g){console.error("Failed to parse chunk:",g)}}}}}function j(e,t){const[a,s]=o.useState([]),[n,c]=o.useState(!1),[h,i]=o.useState(null),u=o.useRef(null),f=o.useRef(new k(e,t)),m=o.useCallback(async()=>{try{const l=await f.current.initConversation();return u.current=l,l}catch(l){throw i(l),l}},[]),y=o.useCallback(async l=>{u.current||await m();const b={id:Date.now().toString(),role:"user",content:l,timestamp:new Date};s(d=>[...d,b]),c(!0),i(null);const v={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};s(d=>[...d,v]);try{const d=f.current.streamMessage(u.current,l);for await(const w of d)s(p=>p.map(_=>_.id===v.id?{..._,content:_.content+w}:_));s(w=>w.map(p=>p.id===v.id?{...p,isStreaming:!1}:p))}catch(d){i(d),s(w=>w.filter(p=>p.id!==v.id))}finally{c(!1)}},[m]),g=o.useCallback(()=>{s([]),u.current=null},[]);return{messages:a,isLoading:n,error:h,sendMessage:y,clearMessages:g}}function M({messages:e}){return r.jsx("div",{className:"chat-wrapper__messages",children:e.map(t=>r.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${t.role}`,children:[r.jsxs("div",{className:"chat-wrapper__message-content",children:[t.content,t.isStreaming&&r.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),r.jsx("div",{className:"chat-wrapper__message-timestamp",children:t.timestamp.toLocaleTimeString()})]},t.id))})}function E({onSend:e,disabled:t,placeholder:a}){const[s,n]=o.useState(""),c=()=>{s.trim()&&!t&&(e(s.trim()),n(""))},h=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),c())};return r.jsxs("div",{className:"chat-wrapper__input",children:[r.jsx("textarea",{value:s,onChange:i=>n(i.target.value),onKeyPress:h,placeholder:a,disabled:t,className:"chat-wrapper__textarea",rows:1}),r.jsx("button",{onClick:c,disabled:t||!s.trim(),className:"chat-wrapper__send-button",children:"Send"})]})}function x(e){var t,a,s="";if(typeof e=="string"||typeof e=="number")s+=e;else if(typeof e=="object")if(Array.isArray(e)){var n=e.length;for(t=0;t<n;t++)e[t]&&(a=x(e[t]))&&(s&&(s+=" "),s+=a)}else for(a in e)e[a]&&(s&&(s+=" "),s+=a);return s}function K(){for(var e,t,a=0,s="",n=arguments.length;a<n;a++)(e=arguments[a])&&(t=x(e))&&(s&&(s+=" "),s+=t);return s}function $(e){const{messages:t,isLoading:a,error:s,sendMessage:n}=j(e.apiEndpoint,e.apiKey);o.useEffect(()=>{e.onError&&s&&e.onError(s)},[s,e]);const c=K("chat-wrapper",`chat-wrapper--${e.mode}`,e.position&&`chat-wrapper--${e.position}`,e.theme&&`chat-wrapper--${e.theme}`);return r.jsxs("div",{className:c,style:e.customStyles,children:[r.jsx("div",{className:"chat-wrapper__header",children:r.jsx("h2",{className:"chat-wrapper__title",children:e.appName})}),r.jsx(M,{messages:t}),r.jsx(E,{onSend:n,disabled:a,placeholder:e.placeholder||"Type a message..."}),s&&r.jsxs("div",{className:"chat-wrapper__error",children:["Error: ",s.message]})]})}exports.ChatWrapper=$;exports.useChatConnection=j;
