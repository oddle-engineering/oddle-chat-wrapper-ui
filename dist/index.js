"use strict";var se=Object.defineProperty;var ae=(l,t,n)=>t in l?se(l,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):l[t]=n;var H=(l,t,n)=>ae(l,typeof t!="symbol"?t+"":t,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("react/jsx-runtime"),s=require("react");function re({onSend:l,disabled:t,placeholder:n,value:o,onChange:p,onStop:m,onClear:T,showStopButton:x,showClearButton:f}){const w=()=>{const i=o||"";i.trim()&&!t&&(l(i.trim()),p&&p(""))},u=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),w())},S=()=>{m&&m()},j=()=>{T&&T()};return a.jsxs("div",{className:"chat-wrapper__input",children:[a.jsx("textarea",{value:o||"",onChange:i=>p?p(i.target.value):void 0,onKeyPress:u,placeholder:n,disabled:t,className:"chat-wrapper__textarea",rows:1}),a.jsxs("div",{className:"chat-wrapper__input-buttons",children:[x&&a.jsx("button",{onClick:S,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),f&&!t&&a.jsx("button",{onClick:j,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),a.jsx("button",{onClick:w,disabled:t||!(o!=null&&o.trim()),className:"chat-wrapper__send-button",children:t?"Sending...":"Send"})]})]})}function ne({apiUrl:l,config:t,tools:n,initialMessages:o=[]}){const[p,m]=s.useState(o),[T,x]=s.useState(""),[f,w]=s.useState(!1),[u,S]=s.useState(null),[j,i]=s.useState([]),[K,M]=s.useState([]),[g,E]=s.useState([]),[y,D]=s.useState([]),[B,k]=s.useState(""),[G,R]=s.useState(!1),[J,$]=s.useState(""),z=s.useRef(null),q=s.useRef(null),v=s.useRef(null),A=s.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),U=s.useCallback(()=>{var e;(e=z.current)==null||e.scrollIntoView({behavior:"smooth"})},[]);s.useEffect(()=>{n&&Object.keys(n).length>0&&console.log("Available tools:",Object.keys(n))},[n]),s.useEffect(()=>{U()},[p,U]),s.useEffect(()=>{t.onStreamingStatusChange&&t.onStreamingStatusChange(B)},[B,t]);const b=s.useCallback(e=>{const d=q.current;d&&m(C=>C.map(h=>h.id===d?e(h):h))},[]),W=s.useCallback(()=>(t.endpoint||"conversation")==="brief-planner"?`${l}/api/brief-planner`:u?`${l}/api/conversation/${u}`:`${l}/api/conversation/init`,[l,t.endpoint,u]),F=s.useCallback(e=>{var d,C,h,O,c,I,_,P;switch(console.log("Processing stream event:",e.type,e),e.type){case"event":e.event==="latitude-event"?((d=e.data)==null?void 0:d.type)==="chain-started"?(k("Planning chain started"),R(!0),$("ðŸ”— Starting comprehensive planning chain...")):((C=e.data)==null?void 0:C.type)==="step-started"?(k("Planning step started"),R(!0),$("ðŸ“Š Executing planning step...")):((h=e.data)==null?void 0:h.type)==="provider-completed"?(k("AI planning completed"),R(!1),$(""),(O=e.data.response)!=null&&O.text&&b(r=>({...r,content:e.data.response.text,isStreaming:!1}))):((c=e.data)==null?void 0:c.type)==="chain-completed"&&(k("Planning completed"),R(!1),$(""),e.data.uuid&&S(e.data.uuid),b(r=>({...r,isStreaming:!1}))):e.event==="provider-event"&&((I=e.data)==null?void 0:I.type)==="text-delta"&&(R(!1),$(""),b(r=>({...r,content:r.content+e.data.textDelta})));break;case"text-delta":e.content&&b(r=>({...r,content:r.content+e.content}));break;case"tool-result":if(console.log("Tool result received:",e),e.tool&&e.data&&(e.data.id||e.data.success)){const r={id:e.data.id||A(),title:e.data.title||`${e.tool} result`,description:e.data.description,status:e.data.status||"completed",created_at:e.data.created_at||new Date().toISOString(),...e.data};i(N=>[...N,r])}e.todos&&(M(e.todos),t.onToolResult&&t.onToolResult("todos",e.todos)),e.briefs&&(E(e.briefs),t.onToolResult&&t.onToolResult("briefs",e.briefs));break;case"finished":k("Stream finished"),e.uuid&&S(e.uuid),(P=(_=e.result)==null?void 0:_.response)!=null&&P.text?b(r=>({...r,content:e.result.response.text,isStreaming:!1})):b(r=>({...r,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",e.error),b(r=>({...r,content:`Stream Error: ${e.error}`,isStreaming:!1}));break;case"error":console.error("API error:",e.error),b(r=>({...r,content:`Error: ${e.error}`,isStreaming:!1}));break}},[b,A,t]),V=s.useCallback(async(e,d)=>{if(!e.trim()||f)return;const C={id:A(),role:"user",content:e.trim(),timestamp:new Date,media:d};m(c=>[...c,C]),w(!0),k("Starting...");const h=A();q.current=h;const O={id:h,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};m(c=>[...c,O]);try{v.current=new AbortController;const c=W(),I=t.endpoint==="brief-planner"?{messages:[...p,C],promptPath:t.promptPath||"briefPlanner",conversationUuid:u,todos:K,briefs:g,media:y}:{message:e.trim(),tools:n?Object.keys(n):[]};console.log("Sending request to:",c);const _=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify(I),signal:v.current.signal});if(!_.ok)throw new Error(`HTTP error! status: ${_.status}`);if(!u&&t.endpoint!=="brief-planner"){const P=await _.json();S(P.conversationId);const r=`${l}/api/conversation/${P.conversationId}`,N=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify({message:e.trim()}),signal:v.current.signal});if(!N.ok)throw new Error(`HTTP error! status: ${N.status}`);await L(N)}else await L(_)}catch(c){c instanceof Error&&c.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",c),b(I=>({...I,content:`Sorry, there was an error: ${c instanceof Error?c.message:"Unknown error"}`,isStreaming:!1})),t.onError&&t.onError(c instanceof Error?c:new Error("Unknown error")))}finally{w(!1),k(""),R(!1),$(""),v.current=null,q.current=null}},[f,A,p,u,K,g,y,n,t,l,W,b,F]),L=s.useCallback(async e=>{var O;const d=(O=e.body)==null?void 0:O.getReader(),C=new TextDecoder;if(!d)throw new Error("No response body reader available");let h="";for(;;){const{done:c,value:I}=await d.read();if(c){console.log("Stream completed");break}h+=C.decode(I,{stream:!0});const _=h.split(/\r?\n/);h=_.pop()||"";for(const P of _)if(P.startsWith("data: ")){const r=P.slice(6).trim();if(r==="[DONE]"||r==="")continue;try{const N=JSON.parse(r);F(N)}catch(N){console.error("Failed to parse event:",N)}}}},[F]),Q=s.useCallback(()=>{v.current&&(v.current.abort(),w(!1),k(""),R(!1),$(""))},[]),X=s.useCallback(()=>{m(o),S(null),i([]),M([]),E([]),D([]),k(""),R(!1),$(""),console.log("Chat cleared")},[o]),Y=((...e)=>e.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${t.mode}`,t.position&&`chat-wrapper--${t.position}`,t.theme&&`chat-wrapper--${t.theme}`),Z=()=>t.mode==="modal"?a.jsx("div",{className:"chat-wrapper-overlay"}):null,ee=()=>!G||!J?null:a.jsx("div",{className:"chat-wrapper__thinking",children:a.jsxs("div",{className:"chat-wrapper__thinking-content",children:[a.jsx("span",{className:"chat-wrapper__thinking-spinner"}),a.jsx("span",{children:J})]})}),te=()=>{var e;return!((e=t.features)!=null&&e.showToolResults)||j.length===0?null:a.jsxs("div",{className:"chat-wrapper__tool-results",children:[a.jsx("h4",{children:"Tool Results"}),a.jsx("div",{className:"chat-wrapper__tool-results-list",children:j.map(d=>a.jsxs("div",{className:"chat-wrapper__tool-result",children:[a.jsx("div",{className:"chat-wrapper__tool-result-title",children:d.title}),d.description&&a.jsx("div",{className:"chat-wrapper__tool-result-description",children:d.description}),a.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",d.status||"completed"]})]},d.id))})]})};return a.jsxs(a.Fragment,{children:[Z(),a.jsxs("div",{className:Y,style:t.customStyles,children:[a.jsxs("div",{className:"chat-wrapper__header",children:[a.jsx("h2",{className:"chat-wrapper__title",children:t.appName}),B&&a.jsx("div",{className:"chat-wrapper__status",children:B})]}),ee(),a.jsxs("div",{className:"chat-wrapper__messages",children:[p.map(e=>a.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[a.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&a.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),a.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id)),a.jsx("div",{ref:z})]}),te(),a.jsx(re,{onSend:V,disabled:f,placeholder:t.placeholder||"Type a message...",value:T,onChange:x,onStop:Q,onClear:X,showStopButton:f,showClearButton:p.length>0}),t.onError&&a.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class oe{constructor(t,n){H(this,"baseUrl");H(this,"apiKey");this.baseUrl=t,this.apiKey=n}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,n){const o=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:n})});if(!o.ok)throw new Error("Failed to send message");if(!o.body)throw new Error("No response body");const p=o.body.getReader(),m=new TextDecoder;for(;;){const{done:T,value:x}=await p.read();if(T)break;const w=m.decode(x).split(`
`);for(const u of w)if(u.startsWith("data: ")){const S=u.slice(6);if(S==="[DONE]")return;try{yield JSON.parse(S).content||""}catch(j){console.error("Failed to parse chunk:",j)}}}}}function ie(l,t){const[n,o]=s.useState([]),[p,m]=s.useState(!1),[T,x]=s.useState(null),f=s.useRef(null),w=s.useRef(new oe(l,t)),u=s.useCallback(async()=>{try{const i=await w.current.initConversation();return f.current=i,i}catch(i){throw x(i),i}},[]),S=s.useCallback(async i=>{f.current||await u();const K={id:Date.now().toString(),role:"user",content:i,timestamp:new Date};o(g=>[...g,K]),m(!0),x(null);const M={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};o(g=>[...g,M]);try{const g=w.current.streamMessage(f.current,i);for await(const E of g)o(y=>y.map(D=>D.id===M.id?{...D,content:D.content+E}:D));o(E=>E.map(y=>y.id===M.id?{...y,isStreaming:!1}:y))}catch(g){x(g),o(E=>E.filter(y=>y.id!==M.id))}finally{m(!1)}},[u]),j=s.useCallback(()=>{o([]),f.current=null},[]);return{messages:n,isLoading:p,error:T,sendMessage:S,clearMessages:j}}exports.ChatWrapper=ne;exports.useChatConnection=ie;
