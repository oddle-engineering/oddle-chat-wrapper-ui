"use strict";var S=Object.defineProperty;var C=(r,e,t)=>e in r?S(r,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):r[e]=t;var j=(r,e,t)=>C(r,typeof e!="symbol"?e+"":e,t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("react/jsx-runtime"),o=require("react");class N{constructor(e,t){j(this,"baseUrl");j(this,"apiKey");this.baseUrl=e,this.apiKey=t}getHeaders(){const e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async initConversation(){const e=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!e.ok)throw new Error("Failed to initialize conversation");return(await e.json()).conversationId}async*streamMessage(e,t){const s=await fetch(`${this.baseUrl}/api/conversation/${e}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:t})});if(!s.ok)throw new Error("Failed to send message");if(!s.body)throw new Error("No response body");const c=s.body.getReader(),n=new TextDecoder;for(;;){const{done:d,value:i}=await c.read();if(d)break;const w=n.decode(i).split(`
`);for(const h of w)if(h.startsWith("data: ")){const f=h.slice(6);if(f==="[DONE]")return;try{yield JSON.parse(f).content||""}catch(v){console.error("Failed to parse chunk:",v)}}}}}function b(r,e){const[t,s]=o.useState([]),[c,n]=o.useState(!1),[d,i]=o.useState(null),p=o.useRef(null),w=o.useRef(new N(r,e)),h=o.useCallback(async()=>{try{const l=await w.current.initConversation();return p.current=l,l}catch(l){throw i(l),l}},[]),f=o.useCallback(async l=>{p.current||await h();const x={id:Date.now().toString(),role:"user",content:l,timestamp:new Date};s(u=>[...u,x]),n(!0),i(null);const _={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};s(u=>[...u,_]);try{const u=w.current.streamMessage(p.current,l);for await(const y of u)s(m=>m.map(g=>g.id===_.id?{...g,content:g.content+y}:g));s(y=>y.map(m=>m.id===_.id?{...m,isStreaming:!1}:m))}catch(u){i(u),s(y=>y.filter(m=>m.id!==_.id))}finally{n(!1)}},[h]),v=o.useCallback(()=>{s([]),p.current=null},[]);return{messages:t,isLoading:c,error:d,sendMessage:f,clearMessages:v}}function k({messages:r}){return a.jsx("div",{className:"chat-wrapper__messages",children:r.map(e=>a.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[a.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&a.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),a.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id))})}function M({onSend:r,disabled:e,placeholder:t}){const[s,c]=o.useState(""),n=()=>{s.trim()&&!e&&(r(s.trim()),c(""))},d=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),n())};return a.jsxs("div",{className:"chat-wrapper__input",children:[a.jsx("textarea",{value:s,onChange:i=>c(i.target.value),onKeyPress:d,placeholder:t,disabled:e,className:"chat-wrapper__textarea",rows:1}),a.jsx("button",{onClick:n,disabled:e||!s.trim(),className:"chat-wrapper__send-button",children:"Send"})]})}function E({apiUrl:r,config:e,tools:t}){const{messages:s,isLoading:c,error:n,sendMessage:d}=b(r,e.apiKey);t&&Object.keys(t).length>0&&console.log("Available tools:",Object.keys(t)),o.useEffect(()=>{e.onError&&n&&e.onError(n)},[n,e]);const p=((...h)=>h.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${e.mode}`,e.position&&`chat-wrapper--${e.position}`,e.theme&&`chat-wrapper--${e.theme}`),w=()=>e.mode==="modal"?a.jsx("div",{className:"chat-wrapper-overlay"}):null;return a.jsxs(a.Fragment,{children:[w(),a.jsxs("div",{className:p,style:e.customStyles,children:[a.jsx("div",{className:"chat-wrapper__header",children:a.jsx("h2",{className:"chat-wrapper__title",children:e.appName})}),a.jsx(k,{messages:s}),a.jsx(M,{onSend:d,disabled:c,placeholder:e.placeholder||"Type a message..."}),n&&a.jsxs("div",{className:"chat-wrapper__error",children:["Error: ",n.message]})]})]})}exports.ChatWrapper=E;exports.useChatConnection=b;
