"use strict";var te=Object.defineProperty;var se=(d,t,n)=>t in d?te(d,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[t]=n;var F=(d,t,n)=>se(d,typeof t!="symbol"?t+"":t,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("react/jsx-runtime"),s=require("react");function ae({onSend:d,disabled:t,placeholder:n,value:o,onChange:u,onStop:h,onClear:R,showStopButton:y,showClearButton:m}){const w=()=>{const i=o||"";i.trim()&&!t&&(d(i.trim()),u&&u(""))},f=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),w())},b=()=>{h&&h()},_=()=>{R&&R()};return a.jsxs("div",{className:"chat-wrapper__input",children:[a.jsx("textarea",{value:o||"",onChange:i=>u?u(i.target.value):void 0,onKeyPress:f,placeholder:n,disabled:t,className:"chat-wrapper__textarea",rows:1}),a.jsxs("div",{className:"chat-wrapper__input-buttons",children:[y&&a.jsx("button",{onClick:b,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),m&&!t&&a.jsx("button",{onClick:_,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),a.jsx("button",{onClick:w,disabled:t||!(o!=null&&o.trim()),className:"chat-wrapper__send-button",children:t?"Sending...":"Send"})]})]})}function re({apiUrl:d,config:t,tools:n,initialMessages:o=[]}){const[u,h]=s.useState(o),[R,y]=s.useState(""),[m,w]=s.useState(!1),[f,b]=s.useState(null),[_,i]=s.useState([]),[K,I]=s.useState([]),[g,E]=s.useState([]),[x,O]=s.useState([]),[B,j]=s.useState(""),[z,T]=s.useState(!1),[J,$]=s.useState(""),H=s.useRef(null),q=s.useRef(null),P=s.useRef(null),D=s.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),W=s.useCallback(()=>{var e;(e=H.current)==null||e.scrollIntoView({behavior:"smooth"})},[]);s.useEffect(()=>{n&&Object.keys(n).length>0&&console.log("Available tools:",Object.keys(n))},[n]),s.useEffect(()=>{W()},[u,W]),s.useEffect(()=>{t.onStreamingStatusChange&&t.onStreamingStatusChange(B)},[B,t]);const S=s.useCallback(e=>{const l=q.current;l&&h(k=>k.map(p=>p.id===l?e(p):p))},[]),U=s.useCallback(e=>{var l,k,p,M,c,C,N,v;switch(console.log("Processing stream event:",e.type,e),e.type){case"event":e.event==="latitude-event"?((l=e.data)==null?void 0:l.type)==="chain-started"?(j("Planning chain started"),T(!0),$("ðŸ”— Starting comprehensive planning chain...")):((k=e.data)==null?void 0:k.type)==="step-started"?(j("Planning step started"),T(!0),$("ðŸ“Š Executing planning step...")):((p=e.data)==null?void 0:p.type)==="provider-completed"?(j("AI planning completed"),T(!1),$(""),(M=e.data.response)!=null&&M.text&&S(r=>({...r,content:e.data.response.text,isStreaming:!1}))):((c=e.data)==null?void 0:c.type)==="chain-completed"&&(j("Planning completed"),T(!1),$(""),e.data.uuid&&b(e.data.uuid),S(r=>({...r,isStreaming:!1}))):e.event==="provider-event"&&((C=e.data)==null?void 0:C.type)==="text-delta"&&(T(!1),$(""),S(r=>({...r,content:r.content+e.data.textDelta})));break;case"text-delta":e.content&&S(r=>({...r,content:r.content+e.content}));break;case"tool-result":if(console.log("Tool result received:",e),e.tool&&e.data&&(e.data.id||e.data.success)){const r={id:e.data.id||D(),title:e.data.title||`${e.tool} result`,description:e.data.description,status:e.data.status||"completed",created_at:e.data.created_at||new Date().toISOString(),...e.data};i(A=>[...A,r])}e.todos&&(I(e.todos),t.onToolResult&&t.onToolResult("todos",e.todos)),e.briefs&&(E(e.briefs),t.onToolResult&&t.onToolResult("briefs",e.briefs));break;case"finished":j("Stream finished"),e.uuid&&b(e.uuid),(v=(N=e.result)==null?void 0:N.response)!=null&&v.text?S(r=>({...r,content:e.result.response.text,isStreaming:!1})):S(r=>({...r,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",e.error),S(r=>({...r,content:`Stream Error: ${e.error}`,isStreaming:!1}));break;case"error":console.error("API error:",e.error),S(r=>({...r,content:`Error: ${e.error}`,isStreaming:!1}));break}},[S,D,t]),L=s.useCallback(async(e,l)=>{if(!e.trim()||m)return;const k={id:D(),role:"user",content:e.trim(),timestamp:new Date,media:l};h(c=>[...c,k]),w(!0),j("Starting...");const p=D();q.current=p;const M={id:p,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};h(c=>[...c,M]);try{P.current=new AbortController;const c=t.endpoint==="brief-planner"?`${d}/api/brief-planner`:f?`${d}/api/conversation/${f}`:`${d}/api/conversation/init`,C=t.endpoint==="brief-planner"?{messages:[...u,k],promptPath:t.promptPath||"briefPlanner",conversationUuid:f,todos:K,briefs:g,media:l||[]}:{message:e.trim(),tools:n?Object.keys(n):[]};console.log("Sending request to:",c),console.log("Request payload:",JSON.stringify(C,null,2));const N=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify(C),signal:P.current.signal});if(!N.ok)throw new Error(`HTTP error! status: ${N.status}`);await G(N)}catch(c){c instanceof Error&&c.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",c),S(C=>({...C,content:`Sorry, there was an error: ${c instanceof Error?c.message:"Unknown error"}`,isStreaming:!1})),t.onError&&t.onError(c instanceof Error?c:new Error("Unknown error")))}finally{w(!1),j(""),T(!1),$(""),P.current=null,q.current=null}},[m,D,u,f,K,g,x,n,t,d,S,U]),G=s.useCallback(async e=>{var M;const l=(M=e.body)==null?void 0:M.getReader(),k=new TextDecoder;if(!l)throw new Error("No response body reader available");let p="";for(;;){const{done:c,value:C}=await l.read();if(c){console.log("Stream completed");break}p+=k.decode(C,{stream:!0});const N=p.split(/\r?\n/);p=N.pop()||"";for(const v of N)if(v.startsWith("data: ")){const r=v.slice(6).trim();if(r==="[DONE]"||r==="")continue;try{const A=JSON.parse(r);U(A)}catch(A){console.error("Failed to parse event:",A)}}}},[U]),V=s.useCallback(()=>{P.current&&(P.current.abort(),w(!1),j(""),T(!1),$(""))},[]),Q=s.useCallback(()=>{h(o),b(null),i([]),I([]),E([]),O([]),j(""),T(!1),$(""),console.log("Chat cleared")},[o]),X=((...e)=>e.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${t.mode}`,t.position&&`chat-wrapper--${t.position}`,t.theme&&`chat-wrapper--${t.theme}`),Y=()=>t.mode==="modal"?a.jsx("div",{className:"chat-wrapper-overlay"}):null,Z=()=>!z||!J?null:a.jsx("div",{className:"chat-wrapper__thinking",children:a.jsxs("div",{className:"chat-wrapper__thinking-content",children:[a.jsx("span",{className:"chat-wrapper__thinking-spinner"}),a.jsx("span",{children:J})]})}),ee=()=>{var e;return!((e=t.features)!=null&&e.showToolResults)||_.length===0?null:a.jsxs("div",{className:"chat-wrapper__tool-results",children:[a.jsx("h4",{children:"Tool Results"}),a.jsx("div",{className:"chat-wrapper__tool-results-list",children:_.map(l=>a.jsxs("div",{className:"chat-wrapper__tool-result",children:[a.jsx("div",{className:"chat-wrapper__tool-result-title",children:l.title}),l.description&&a.jsx("div",{className:"chat-wrapper__tool-result-description",children:l.description}),a.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",l.status||"completed"]})]},l.id))})]})};return a.jsxs(a.Fragment,{children:[Y(),a.jsxs("div",{className:X,style:t.customStyles,children:[a.jsxs("div",{className:"chat-wrapper__header",children:[a.jsx("h2",{className:"chat-wrapper__title",children:t.appName}),B&&a.jsx("div",{className:"chat-wrapper__status",children:B})]}),Z(),a.jsxs("div",{className:"chat-wrapper__messages",children:[u.map(e=>a.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[a.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&a.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),a.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id)),a.jsx("div",{ref:H})]}),ee(),a.jsx(ae,{onSend:L,disabled:m,placeholder:t.placeholder||"Type a message...",value:R,onChange:y,onStop:V,onClear:Q,showStopButton:m,showClearButton:u.length>0}),t.onError&&a.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class ne{constructor(t,n){F(this,"baseUrl");F(this,"apiKey");this.baseUrl=t,this.apiKey=n}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,n){const o=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:n})});if(!o.ok)throw new Error("Failed to send message");if(!o.body)throw new Error("No response body");const u=o.body.getReader(),h=new TextDecoder;for(;;){const{done:R,value:y}=await u.read();if(R)break;const w=h.decode(y).split(`
`);for(const f of w)if(f.startsWith("data: ")){const b=f.slice(6);if(b==="[DONE]")return;try{yield JSON.parse(b).content||""}catch(_){console.error("Failed to parse chunk:",_)}}}}}function oe(d,t){const[n,o]=s.useState([]),[u,h]=s.useState(!1),[R,y]=s.useState(null),m=s.useRef(null),w=s.useRef(new ne(d,t)),f=s.useCallback(async()=>{try{const i=await w.current.initConversation();return m.current=i,i}catch(i){throw y(i),i}},[]),b=s.useCallback(async i=>{m.current||await f();const K={id:Date.now().toString(),role:"user",content:i,timestamp:new Date};o(g=>[...g,K]),h(!0),y(null);const I={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};o(g=>[...g,I]);try{const g=w.current.streamMessage(m.current,i);for await(const E of g)o(x=>x.map(O=>O.id===I.id?{...O,content:O.content+E}:O));o(E=>E.map(x=>x.id===I.id?{...x,isStreaming:!1}:x))}catch(g){y(g),o(E=>E.filter(x=>x.id!==I.id))}finally{h(!1)}},[f]),_=s.useCallback(()=>{o([]),m.current=null},[]);return{messages:n,isLoading:u,error:R,sendMessage:b,clearMessages:_}}exports.ChatWrapper=re;exports.useChatConnection=oe;
