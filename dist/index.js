"use strict";var te=Object.defineProperty;var se=(d,t,i)=>t in d?te(d,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):d[t]=i;var J=(d,t,i)=>se(d,typeof t!="symbol"?t+"":t,i);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("react/jsx-runtime"),s=require("react");function ae({onSend:d,disabled:t,placeholder:i,value:n,onChange:u,onStop:h,onClear:R,showStopButton:_,showClearButton:m}){const f=()=>{const o=n||"";o.trim()&&!t&&(d(o.trim()),u&&u(""))},w=o=>{o.key==="Enter"&&!o.shiftKey&&(o.preventDefault(),f())},S=()=>{h&&h()},x=()=>{R&&R()};return a.jsxs("div",{className:"chat-wrapper__input",children:[a.jsx("textarea",{value:n||"",onChange:o=>u?u(o.target.value):void 0,onKeyPress:w,placeholder:i,disabled:t,className:"chat-wrapper__textarea",rows:1}),a.jsxs("div",{className:"chat-wrapper__input-buttons",children:[_&&a.jsx("button",{onClick:S,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),m&&!t&&a.jsx("button",{onClick:x,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),a.jsx("button",{onClick:f,disabled:t||!(n!=null&&n.trim()),className:"chat-wrapper__send-button",children:t?"Sending...":"Send"})]})]})}function re({apiUrl:d,config:t,tools:i,initialMessages:n=[]}){const[u,h]=s.useState(n),[R,_]=s.useState(""),[m,f]=s.useState(!1),[w,S]=s.useState(null),[x,o]=s.useState([]),[K,M]=s.useState([]),[b,E]=s.useState([]),[j,v]=s.useState([]),[U,C]=s.useState(""),[L,$]=s.useState(!1),[F,I]=s.useState(""),H=s.useRef(null),B=s.useRef(null),D=s.useRef(null),A=s.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),z=s.useCallback(()=>{var e;(e=H.current)==null||e.scrollIntoView({behavior:"smooth"})},[]);s.useEffect(()=>{i&&Object.keys(i).length>0&&console.log("Available tools:",Object.keys(i))},[i]),s.useEffect(()=>{z()},[u,z]),s.useEffect(()=>{t.onStreamingStatusChange&&t.onStreamingStatusChange(U)},[U,t]);const g=s.useCallback(e=>{const l=B.current;l&&h(k=>k.map(p=>p.id===l?e(p):p))},[]),q=s.useCallback(e=>{var l,k,p,O,c,N,y,P;switch(console.log("Processing stream event:",e.type,e),e.type){case"event":e.event==="latitude-event"?((l=e.data)==null?void 0:l.type)==="chain-started"?(C("Planning chain started"),$(!0),I("ðŸ”— Starting comprehensive planning chain...")):((k=e.data)==null?void 0:k.type)==="step-started"?(C("Planning step started"),$(!0),I("ðŸ“Š Executing planning step...")):((p=e.data)==null?void 0:p.type)==="provider-completed"?(C("AI planning completed"),$(!1),I(""),(O=e.data.response)!=null&&O.text&&g(r=>({...r,content:e.data.response.text,isStreaming:!1}))):((c=e.data)==null?void 0:c.type)==="chain-completed"&&(C("Planning completed"),$(!1),I(""),e.data.uuid&&S(e.data.uuid),g(r=>({...r,isStreaming:!1}))):e.event==="provider-event"&&((N=e.data)==null?void 0:N.type)==="text-delta"&&($(!1),I(""),g(r=>({...r,content:r.content+e.data.textDelta})));break;case"text-delta":e.content&&g(r=>({...r,content:r.content+e.content}));break;case"tool-result":if(console.log("Tool result received:",e),e.tool&&e.data&&(e.data.id||e.data.success)){const r={id:e.data.id||A(),title:e.data.title||`${e.tool} result`,description:e.data.description,status:e.data.status||"completed",created_at:e.data.created_at||new Date().toISOString(),...e.data};o(T=>[...T,r])}e.todos&&(M(e.todos),t.onToolResult&&t.onToolResult("todos",e.todos)),e.briefs&&(E(e.briefs),t.onToolResult&&t.onToolResult("briefs",e.briefs));break;case"finished":C("Stream finished"),e.uuid&&S(e.uuid),(P=(y=e.result)==null?void 0:y.response)!=null&&P.text?g(r=>({...r,content:e.result.response.text,isStreaming:!1})):g(r=>({...r,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",e.error),g(r=>({...r,content:`Stream Error: ${e.error}`,isStreaming:!1}));break;case"error":console.error("API error:",e.error),g(r=>({...r,content:`Error: ${e.error}`,isStreaming:!1}));break}},[g,A,t]),G=s.useCallback(async(e,l)=>{if(!e.trim()||m)return;const k={id:A(),role:"user",content:e.trim(),timestamp:new Date,media:l};h(c=>[...c,k]),f(!0),C("Starting...");const p=A();B.current=p;const O={id:p,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};h(c=>[...c,O]);try{D.current=new AbortController;const c=`${d}/api/brief-planner`,N={messages:[...u,k],promptPath:t.promptPath||"briefPlanner",conversationUuid:w,todos:K,briefs:b,media:l||[]};console.log("Sending request to:",c),console.log("Request payload:",JSON.stringify(N,null,2));const y=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify(N),signal:D.current.signal});if(!y.ok)throw new Error(`HTTP error! status: ${y.status}`);if(!w&&t.endpoint!=="brief-planner"){const P=await y.json();S(P.conversationId);const r=`${d}/api/conversation/${P.conversationId}`,T=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify({message:e.trim()}),signal:D.current.signal});if(!T.ok)throw new Error(`HTTP error! status: ${T.status}`);await W(T)}else await W(y)}catch(c){c instanceof Error&&c.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",c),g(N=>({...N,content:`Sorry, there was an error: ${c instanceof Error?c.message:"Unknown error"}`,isStreaming:!1})),t.onError&&t.onError(c instanceof Error?c:new Error("Unknown error")))}finally{f(!1),C(""),$(!1),I(""),D.current=null,B.current=null}},[m,A,u,w,K,b,j,i,t,d,g,q]),W=s.useCallback(async e=>{var O;const l=(O=e.body)==null?void 0:O.getReader(),k=new TextDecoder;if(!l)throw new Error("No response body reader available");let p="";for(;;){const{done:c,value:N}=await l.read();if(c){console.log("Stream completed");break}p+=k.decode(N,{stream:!0});const y=p.split(/\r?\n/);p=y.pop()||"";for(const P of y)if(P.startsWith("data: ")){const r=P.slice(6).trim();if(r==="[DONE]"||r==="")continue;try{const T=JSON.parse(r);q(T)}catch(T){console.error("Failed to parse event:",T)}}}},[q]),V=s.useCallback(()=>{D.current&&(D.current.abort(),f(!1),C(""),$(!1),I(""))},[]),Q=s.useCallback(()=>{h(n),S(null),o([]),M([]),E([]),v([]),C(""),$(!1),I(""),console.log("Chat cleared")},[n]),X=((...e)=>e.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${t.mode}`,t.position&&`chat-wrapper--${t.position}`,t.theme&&`chat-wrapper--${t.theme}`),Y=()=>t.mode==="modal"?a.jsx("div",{className:"chat-wrapper-overlay"}):null,Z=()=>!L||!F?null:a.jsx("div",{className:"chat-wrapper__thinking",children:a.jsxs("div",{className:"chat-wrapper__thinking-content",children:[a.jsx("span",{className:"chat-wrapper__thinking-spinner"}),a.jsx("span",{children:F})]})}),ee=()=>{var e;return!((e=t.features)!=null&&e.showToolResults)||x.length===0?null:a.jsxs("div",{className:"chat-wrapper__tool-results",children:[a.jsx("h4",{children:"Tool Results"}),a.jsx("div",{className:"chat-wrapper__tool-results-list",children:x.map(l=>a.jsxs("div",{className:"chat-wrapper__tool-result",children:[a.jsx("div",{className:"chat-wrapper__tool-result-title",children:l.title}),l.description&&a.jsx("div",{className:"chat-wrapper__tool-result-description",children:l.description}),a.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",l.status||"completed"]})]},l.id))})]})};return a.jsxs(a.Fragment,{children:[Y(),a.jsxs("div",{className:X,style:t.customStyles,children:[a.jsxs("div",{className:"chat-wrapper__header",children:[a.jsx("h2",{className:"chat-wrapper__title",children:t.appName}),U&&a.jsx("div",{className:"chat-wrapper__status",children:U})]}),Z(),a.jsxs("div",{className:"chat-wrapper__messages",children:[u.map(e=>a.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[a.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&a.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),a.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id)),a.jsx("div",{ref:H})]}),ee(),a.jsx(ae,{onSend:G,disabled:m,placeholder:t.placeholder||"Type a message...",value:R,onChange:_,onStop:V,onClear:Q,showStopButton:m,showClearButton:u.length>0}),t.onError&&a.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class ne{constructor(t,i){J(this,"baseUrl");J(this,"apiKey");this.baseUrl=t,this.apiKey=i}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,i){const n=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:i})});if(!n.ok)throw new Error("Failed to send message");if(!n.body)throw new Error("No response body");const u=n.body.getReader(),h=new TextDecoder;for(;;){const{done:R,value:_}=await u.read();if(R)break;const f=h.decode(_).split(`
`);for(const w of f)if(w.startsWith("data: ")){const S=w.slice(6);if(S==="[DONE]")return;try{yield JSON.parse(S).content||""}catch(x){console.error("Failed to parse chunk:",x)}}}}}function oe(d,t){const[i,n]=s.useState([]),[u,h]=s.useState(!1),[R,_]=s.useState(null),m=s.useRef(null),f=s.useRef(new ne(d,t)),w=s.useCallback(async()=>{try{const o=await f.current.initConversation();return m.current=o,o}catch(o){throw _(o),o}},[]),S=s.useCallback(async o=>{m.current||await w();const K={id:Date.now().toString(),role:"user",content:o,timestamp:new Date};n(b=>[...b,K]),h(!0),_(null);const M={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};n(b=>[...b,M]);try{const b=f.current.streamMessage(m.current,o);for await(const E of b)n(j=>j.map(v=>v.id===M.id?{...v,content:v.content+E}:v));n(E=>E.map(j=>j.id===M.id?{...j,isStreaming:!1}:j))}catch(b){_(b),n(E=>E.filter(j=>j.id!==M.id))}finally{h(!1)}},[w]),x=s.useCallback(()=>{n([]),m.current=null},[]);return{messages:i,isLoading:u,error:R,sendMessage:S,clearMessages:x}}exports.ChatWrapper=re;exports.useChatConnection=oe;
