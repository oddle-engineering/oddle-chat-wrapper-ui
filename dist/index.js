"use strict";var Q=Object.defineProperty;var X=(c,e,n)=>e in c?Q(c,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):c[e]=n;var K=(c,e,n)=>X(c,typeof e!="symbol"?e+"":e,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("react/jsx-runtime"),r=require("react");function Y({messages:c}){return s.jsx("div",{className:"chat-wrapper__messages",children:c.map(e=>s.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[s.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&s.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),s.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id))})}function Z({onSend:c,disabled:e,placeholder:n,value:o,onChange:p,onStop:b,onClear:$,showStopButton:N,showClearButton:g}){const _=()=>{const i=o||"";i.trim()&&!e&&(c(i.trim()),p&&p(""))},u=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),_())},j=()=>{b&&b()},y=()=>{$&&$()};return s.jsxs("div",{className:"chat-wrapper__input",children:[s.jsx("textarea",{value:o||"",onChange:i=>p?p(i.target.value):void 0,onKeyPress:u,placeholder:n,disabled:e,className:"chat-wrapper__textarea",rows:1}),s.jsxs("div",{className:"chat-wrapper__input-buttons",children:[N&&s.jsx("button",{onClick:j,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),g&&!e&&s.jsx("button",{onClick:y,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),s.jsx("button",{onClick:_,disabled:e||!(o!=null&&o.trim()),className:"chat-wrapper__send-button",children:e?"Sending...":"Send"})]})]})}function ee({apiUrl:c,config:e,tools:n,initialMessages:o=[]}){const[p,b]=r.useState(o),[$,N]=r.useState(""),[g,_]=r.useState(!1),[u,j]=r.useState(null),[y,i]=r.useState([]),[O,h]=r.useState(""),[E,m]=r.useState(!1),[k,f]=r.useState(""),B=r.useRef(null),D=r.useRef(null),P=r.useRef(null),M=r.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),q=r.useCallback(()=>{var t;(t=B.current)==null||t.scrollIntoView({behavior:"smooth"})},[]);r.useEffect(()=>{n&&Object.keys(n).length>0&&console.log("Available tools:",Object.keys(n))},[n]),r.useEffect(()=>{q()},[p,q]),r.useEffect(()=>{e.onStreamingStatusChange&&e.onStreamingStatusChange(O)},[O,e]);const x=r.useCallback(t=>{const d=D.current;d&&b(T=>T.map(w=>w.id===d?t(w):w))},[]),F=r.useCallback(()=>(e.endpoint||"conversation")==="brief-planner"?`${c}/api/brief-planner`:u?`${c}/api/conversation/${u}`:`${c}/api/conversation/init`,[c,e.endpoint,u]),A=r.useCallback(t=>{var d,T,w,v,l,I,C,S;switch(console.log("Processing stream event:",t.type,t),t.type){case"event":t.event==="latitude-event"?((d=t.data)==null?void 0:d.type)==="chain-started"?(h("Planning chain started"),m(!0),f("ðŸ”— Starting comprehensive planning chain...")):((T=t.data)==null?void 0:T.type)==="step-started"?(h("Planning step started"),m(!0),f("ðŸ“Š Executing planning step...")):((w=t.data)==null?void 0:w.type)==="provider-completed"?(h("AI planning completed"),m(!1),f(""),(v=t.data.response)!=null&&v.text&&x(a=>({...a,content:t.data.response.text,isStreaming:!1}))):((l=t.data)==null?void 0:l.type)==="chain-completed"&&(h("Planning completed"),m(!1),f(""),t.data.uuid&&j(t.data.uuid),x(a=>({...a,isStreaming:!1}))):t.event==="provider-event"&&((I=t.data)==null?void 0:I.type)==="text-delta"&&(m(!1),f(""),x(a=>({...a,content:a.content+t.data.textDelta})));break;case"text-delta":t.content&&x(a=>({...a,content:a.content+t.content}));break;case"tool-result":if(console.log("Tool result received:",t),t.tool&&t.data&&(t.data.id||t.data.success)){const a={id:t.data.id||M(),title:t.data.title||`${t.tool} result`,description:t.data.description,status:t.data.status||"completed",created_at:t.data.created_at||new Date().toISOString(),...t.data};i(R=>[...R,a])}t.todos&&e.onToolResult&&e.onToolResult("todos",t.todos),t.briefs&&e.onToolResult&&e.onToolResult("briefs",t.briefs);break;case"finished":h("Stream finished"),t.uuid&&j(t.uuid),(S=(C=t.result)==null?void 0:C.response)!=null&&S.text?x(a=>({...a,content:t.result.response.text,isStreaming:!1})):x(a=>({...a,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",t.error),x(a=>({...a,content:`Stream Error: ${t.error}`,isStreaming:!1}));break;case"error":console.error("API error:",t.error),x(a=>({...a,content:`Error: ${t.error}`,isStreaming:!1}));break}},[x,M,e]),J=r.useCallback(async(t,d)=>{if(!t.trim()||g)return;const T={id:M(),role:"user",content:t.trim(),timestamp:new Date,media:d};b(l=>[...l,T]),_(!0),h("Starting...");const w=M();D.current=w;const v={id:w,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};b(l=>[...l,v]);try{P.current=new AbortController;const l=F(),I=e.endpoint==="brief-planner"?{messages:[...p,T],promptPath:"briefPlanner",conversationUuid:u,todos:y.filter(S=>S.status!==void 0),briefs:y.filter(S=>S.title&&S.description),media:d||[],tools:n?Object.keys(n):[]}:{message:t.trim(),tools:n?Object.keys(n):[]};console.log("Sending request to:",l);const C=await fetch(l,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey&&{Authorization:`Bearer ${e.apiKey}`}},body:JSON.stringify(I),signal:P.current.signal});if(!C.ok)throw new Error(`HTTP error! status: ${C.status}`);if(!u&&e.endpoint!=="brief-planner"){const S=await C.json();j(S.conversationId);const a=`${c}/api/conversation/${S.conversationId}`,R=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json",...e.apiKey&&{Authorization:`Bearer ${e.apiKey}`}},body:JSON.stringify({message:t.trim()}),signal:P.current.signal});if(!R.ok)throw new Error(`HTTP error! status: ${R.status}`);await H(R)}else await H(C)}catch(l){l instanceof Error&&l.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",l),x(I=>({...I,content:`Sorry, there was an error: ${l instanceof Error?l.message:"Unknown error"}`,isStreaming:!1})),e.onError&&e.onError(l instanceof Error?l:new Error("Unknown error")))}finally{_(!1),h(""),m(!1),f(""),P.current=null,D.current=null}},[g,M,p,u,y,n,e,c,F,x,A]),H=r.useCallback(async t=>{var v;const d=(v=t.body)==null?void 0:v.getReader(),T=new TextDecoder;if(!d)throw new Error("No response body reader available");let w="";for(;;){const{done:l,value:I}=await d.read();if(l){console.log("Stream completed");break}w+=T.decode(I,{stream:!0});const C=w.split(/\r?\n/);w=C.pop()||"";for(const S of C)if(S.startsWith("data: ")){const a=S.slice(6).trim();if(a==="[DONE]"||a==="")continue;try{const R=JSON.parse(a);A(R)}catch(R){console.error("Failed to parse event:",R)}}}},[A]),z=r.useCallback(()=>{P.current&&(P.current.abort(),_(!1),h(""),m(!1),f(""))},[]),L=r.useCallback(()=>{b(o),j(null),i([]),h(""),m(!1),f(""),console.log("Chat cleared")},[o]),W=((...t)=>t.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${e.mode}`,e.position&&`chat-wrapper--${e.position}`,e.theme&&`chat-wrapper--${e.theme}`),U=()=>e.mode==="modal"?s.jsx("div",{className:"chat-wrapper-overlay"}):null,G=()=>!E||!k?null:s.jsx("div",{className:"chat-wrapper__thinking",children:s.jsxs("div",{className:"chat-wrapper__thinking-content",children:[s.jsx("span",{className:"chat-wrapper__thinking-spinner"}),s.jsx("span",{children:k})]})}),V=()=>{var t;return!((t=e.features)!=null&&t.showToolResults)||y.length===0?null:s.jsxs("div",{className:"chat-wrapper__tool-results",children:[s.jsx("h4",{children:"Tool Results"}),s.jsx("div",{className:"chat-wrapper__tool-results-list",children:y.map(d=>s.jsxs("div",{className:"chat-wrapper__tool-result",children:[s.jsx("div",{className:"chat-wrapper__tool-result-title",children:d.title}),d.description&&s.jsx("div",{className:"chat-wrapper__tool-result-description",children:d.description}),s.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",d.status||"completed"]})]},d.id))})]})};return s.jsxs(s.Fragment,{children:[U(),s.jsxs("div",{className:W,style:e.customStyles,children:[s.jsxs("div",{className:"chat-wrapper__header",children:[s.jsx("h2",{className:"chat-wrapper__title",children:e.appName}),O&&s.jsx("div",{className:"chat-wrapper__status",children:O})]}),G(),s.jsxs("div",{className:"chat-wrapper__content",children:[s.jsx(Y,{messages:p}),V(),s.jsx("div",{ref:B})]}),s.jsx(Z,{onSend:J,disabled:g,placeholder:e.placeholder||"Type a message...",value:$,onChange:N,onStop:z,onClear:L,showStopButton:g,showClearButton:p.length>0}),e.onError&&s.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class te{constructor(e,n){K(this,"baseUrl");K(this,"apiKey");this.baseUrl=e,this.apiKey=n}getHeaders(){const e={"Content-Type":"application/json"};return this.apiKey&&(e.Authorization=`Bearer ${this.apiKey}`),e}async initConversation(){const e=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!e.ok)throw new Error("Failed to initialize conversation");return(await e.json()).conversationId}async*streamMessage(e,n){const o=await fetch(`${this.baseUrl}/api/conversation/${e}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:n})});if(!o.ok)throw new Error("Failed to send message");if(!o.body)throw new Error("No response body");const p=o.body.getReader(),b=new TextDecoder;for(;;){const{done:$,value:N}=await p.read();if($)break;const _=b.decode(N).split(`
`);for(const u of _)if(u.startsWith("data: ")){const j=u.slice(6);if(j==="[DONE]")return;try{yield JSON.parse(j).content||""}catch(y){console.error("Failed to parse chunk:",y)}}}}}function se(c,e){const[n,o]=r.useState([]),[p,b]=r.useState(!1),[$,N]=r.useState(null),g=r.useRef(null),_=r.useRef(new te(c,e)),u=r.useCallback(async()=>{try{const i=await _.current.initConversation();return g.current=i,i}catch(i){throw N(i),i}},[]),j=r.useCallback(async i=>{g.current||await u();const O={id:Date.now().toString(),role:"user",content:i,timestamp:new Date};o(E=>[...E,O]),b(!0),N(null);const h={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};o(E=>[...E,h]);try{const E=_.current.streamMessage(g.current,i);for await(const m of E)o(k=>k.map(f=>f.id===h.id?{...f,content:f.content+m}:f));o(m=>m.map(k=>k.id===h.id?{...k,isStreaming:!1}:k))}catch(E){N(E),o(m=>m.filter(k=>k.id!==h.id))}finally{b(!1)}},[u]),y=r.useCallback(()=>{o([]),g.current=null},[]);return{messages:n,isLoading:p,error:$,sendMessage:j,clearMessages:y}}exports.ChatWrapper=ee;exports.useChatConnection=se;
