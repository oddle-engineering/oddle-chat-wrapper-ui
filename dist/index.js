"use strict";var te=Object.defineProperty;var se=(d,t,n)=>t in d?te(d,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[t]=n;var F=(d,t,n)=>se(d,typeof t!="symbol"?t+"":t,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const a=require("react/jsx-runtime"),s=require("react");function ae({onSend:d,disabled:t,placeholder:n,value:o,onChange:p,onStop:h,onClear:T,showStopButton:x,showClearButton:m}){const f=()=>{const i=o||"";i.trim()&&!t&&(d(i.trim()),p&&p(""))},w=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),f())},S=()=>{h&&h()},j=()=>{T&&T()};return a.jsxs("div",{className:"chat-wrapper__input",children:[a.jsx("textarea",{value:o||"",onChange:i=>p?p(i.target.value):void 0,onKeyPress:w,placeholder:n,disabled:t,className:"chat-wrapper__textarea",rows:1}),a.jsxs("div",{className:"chat-wrapper__input-buttons",children:[x&&a.jsx("button",{onClick:S,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),m&&!t&&a.jsx("button",{onClick:j,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),a.jsx("button",{onClick:f,disabled:t||!(o!=null&&o.trim()),className:"chat-wrapper__send-button",children:t?"Sending...":"Send"})]})]})}function re({apiUrl:d,config:t,tools:n,initialMessages:o=[]}){const[p,h]=s.useState(o),[T,x]=s.useState(""),[m,f]=s.useState(!1),[w,S]=s.useState(null),[j,i]=s.useState([]),[K,M]=s.useState([]),[g,E]=s.useState([]),[y,D]=s.useState([]),[B,k]=s.useState(""),[L,R]=s.useState(!1),[H,I]=s.useState(""),J=s.useRef(null),U=s.useRef(null),v=s.useRef(null),A=s.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),z=s.useCallback(()=>{var e;(e=J.current)==null||e.scrollIntoView({behavior:"smooth"})},[]);s.useEffect(()=>{n&&Object.keys(n).length>0&&console.log("Available tools:",Object.keys(n))},[n]),s.useEffect(()=>{z()},[p,z]),s.useEffect(()=>{t.onStreamingStatusChange&&t.onStreamingStatusChange(B)},[B,t]);const b=s.useCallback(e=>{const l=U.current;l&&h(C=>C.map(u=>u.id===l?e(u):u))},[]),q=s.useCallback(e=>{var l,C,u,O,c,$,_,P;switch(console.log("Processing stream event:",e.type,e),e.type){case"event":e.event==="latitude-event"?((l=e.data)==null?void 0:l.type)==="chain-started"?(k("Planning chain started"),R(!0),I("ðŸ”— Starting comprehensive planning chain...")):((C=e.data)==null?void 0:C.type)==="step-started"?(k("Planning step started"),R(!0),I("ðŸ“Š Executing planning step...")):((u=e.data)==null?void 0:u.type)==="provider-completed"?(k("AI planning completed"),R(!1),I(""),(O=e.data.response)!=null&&O.text&&b(r=>({...r,content:e.data.response.text,isStreaming:!1}))):((c=e.data)==null?void 0:c.type)==="chain-completed"&&(k("Planning completed"),R(!1),I(""),e.data.uuid&&S(e.data.uuid),b(r=>({...r,isStreaming:!1}))):e.event==="provider-event"&&(($=e.data)==null?void 0:$.type)==="text-delta"&&(R(!1),I(""),b(r=>({...r,content:r.content+e.data.textDelta})));break;case"text-delta":e.content&&b(r=>({...r,content:r.content+e.content}));break;case"tool-result":if(console.log("Tool result received:",e),e.tool&&e.data&&(e.data.id||e.data.success)){const r={id:e.data.id||A(),title:e.data.title||`${e.tool} result`,description:e.data.description,status:e.data.status||"completed",created_at:e.data.created_at||new Date().toISOString(),...e.data};i(N=>[...N,r])}e.todos&&(M(e.todos),t.onToolResult&&t.onToolResult("todos",e.todos)),e.briefs&&(E(e.briefs),t.onToolResult&&t.onToolResult("briefs",e.briefs));break;case"finished":k("Stream finished"),e.uuid&&S(e.uuid),(P=(_=e.result)==null?void 0:_.response)!=null&&P.text?b(r=>({...r,content:e.result.response.text,isStreaming:!1})):b(r=>({...r,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",e.error),b(r=>({...r,content:`Stream Error: ${e.error}`,isStreaming:!1}));break;case"error":console.error("API error:",e.error),b(r=>({...r,content:`Error: ${e.error}`,isStreaming:!1}));break}},[b,A,t]),G=s.useCallback(async(e,l)=>{if(!e.trim()||m)return;const C={id:A(),role:"user",content:e.trim(),timestamp:new Date,media:l};h(c=>[...c,C]),f(!0),k("Starting...");const u=A();U.current=u;const O={id:u,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};h(c=>[...c,O]);try{v.current=new AbortController;const c=`${d}/api/brief-planner`,$=t.endpoint==="brief-planner"?{messages:[...p,C],promptPath:t.promptPath||"briefPlanner",conversationUuid:w,todos:K,briefs:g,media:y}:{message:e.trim(),tools:n?Object.keys(n):[]};console.log("Sending request to:",c);const _=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify($),signal:v.current.signal});if(!_.ok)throw new Error(`HTTP error! status: ${_.status}`);if(!w&&t.endpoint!=="brief-planner"){const P=await _.json();S(P.conversationId);const r=`${d}/api/conversation/${P.conversationId}`,N=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify({message:e.trim()}),signal:v.current.signal});if(!N.ok)throw new Error(`HTTP error! status: ${N.status}`);await W(N)}else await W(_)}catch(c){c instanceof Error&&c.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",c),b($=>({...$,content:`Sorry, there was an error: ${c instanceof Error?c.message:"Unknown error"}`,isStreaming:!1})),t.onError&&t.onError(c instanceof Error?c:new Error("Unknown error")))}finally{f(!1),k(""),R(!1),I(""),v.current=null,U.current=null}},[m,A,p,w,K,g,y,n,t,d,b,q]),W=s.useCallback(async e=>{var O;const l=(O=e.body)==null?void 0:O.getReader(),C=new TextDecoder;if(!l)throw new Error("No response body reader available");let u="";for(;;){const{done:c,value:$}=await l.read();if(c){console.log("Stream completed");break}u+=C.decode($,{stream:!0});const _=u.split(/\r?\n/);u=_.pop()||"";for(const P of _)if(P.startsWith("data: ")){const r=P.slice(6).trim();if(r==="[DONE]"||r==="")continue;try{const N=JSON.parse(r);q(N)}catch(N){console.error("Failed to parse event:",N)}}}},[q]),V=s.useCallback(()=>{v.current&&(v.current.abort(),f(!1),k(""),R(!1),I(""))},[]),Q=s.useCallback(()=>{h(o),S(null),i([]),M([]),E([]),D([]),k(""),R(!1),I(""),console.log("Chat cleared")},[o]),X=((...e)=>e.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${t.mode}`,t.position&&`chat-wrapper--${t.position}`,t.theme&&`chat-wrapper--${t.theme}`),Y=()=>t.mode==="modal"?a.jsx("div",{className:"chat-wrapper-overlay"}):null,Z=()=>!L||!H?null:a.jsx("div",{className:"chat-wrapper__thinking",children:a.jsxs("div",{className:"chat-wrapper__thinking-content",children:[a.jsx("span",{className:"chat-wrapper__thinking-spinner"}),a.jsx("span",{children:H})]})}),ee=()=>{var e;return!((e=t.features)!=null&&e.showToolResults)||j.length===0?null:a.jsxs("div",{className:"chat-wrapper__tool-results",children:[a.jsx("h4",{children:"Tool Results"}),a.jsx("div",{className:"chat-wrapper__tool-results-list",children:j.map(l=>a.jsxs("div",{className:"chat-wrapper__tool-result",children:[a.jsx("div",{className:"chat-wrapper__tool-result-title",children:l.title}),l.description&&a.jsx("div",{className:"chat-wrapper__tool-result-description",children:l.description}),a.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",l.status||"completed"]})]},l.id))})]})};return a.jsxs(a.Fragment,{children:[Y(),a.jsxs("div",{className:X,style:t.customStyles,children:[a.jsxs("div",{className:"chat-wrapper__header",children:[a.jsx("h2",{className:"chat-wrapper__title",children:t.appName}),B&&a.jsx("div",{className:"chat-wrapper__status",children:B})]}),Z(),a.jsxs("div",{className:"chat-wrapper__messages",children:[p.map(e=>a.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[a.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&a.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),a.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id)),a.jsx("div",{ref:J})]}),ee(),a.jsx(ae,{onSend:G,disabled:m,placeholder:t.placeholder||"Type a message...",value:T,onChange:x,onStop:V,onClear:Q,showStopButton:m,showClearButton:p.length>0}),t.onError&&a.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class ne{constructor(t,n){F(this,"baseUrl");F(this,"apiKey");this.baseUrl=t,this.apiKey=n}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,n){const o=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:n})});if(!o.ok)throw new Error("Failed to send message");if(!o.body)throw new Error("No response body");const p=o.body.getReader(),h=new TextDecoder;for(;;){const{done:T,value:x}=await p.read();if(T)break;const f=h.decode(x).split(`
`);for(const w of f)if(w.startsWith("data: ")){const S=w.slice(6);if(S==="[DONE]")return;try{yield JSON.parse(S).content||""}catch(j){console.error("Failed to parse chunk:",j)}}}}}function oe(d,t){const[n,o]=s.useState([]),[p,h]=s.useState(!1),[T,x]=s.useState(null),m=s.useRef(null),f=s.useRef(new ne(d,t)),w=s.useCallback(async()=>{try{const i=await f.current.initConversation();return m.current=i,i}catch(i){throw x(i),i}},[]),S=s.useCallback(async i=>{m.current||await w();const K={id:Date.now().toString(),role:"user",content:i,timestamp:new Date};o(g=>[...g,K]),h(!0),x(null);const M={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};o(g=>[...g,M]);try{const g=f.current.streamMessage(m.current,i);for await(const E of g)o(y=>y.map(D=>D.id===M.id?{...D,content:D.content+E}:D));o(E=>E.map(y=>y.id===M.id?{...y,isStreaming:!1}:y))}catch(g){x(g),o(E=>E.filter(y=>y.id!==M.id))}finally{h(!1)}},[w]),j=s.useCallback(()=>{o([]),m.current=null},[]);return{messages:n,isLoading:p,error:T,sendMessage:S,clearMessages:j}}exports.ChatWrapper=re;exports.useChatConnection=oe;
