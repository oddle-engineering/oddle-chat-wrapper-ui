"use strict";var ie=Object.defineProperty;var le=(d,t,n)=>t in d?ie(d,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):d[t]=n;var U=(d,t,n)=>le(d,typeof t!="symbol"?t+"":t,n);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const s=require("react/jsx-runtime"),r=require("react");function ce({onSend:d,disabled:t,placeholder:n,value:o,onChange:u,onStop:m,onClear:E,showStopButton:_,showClearButton:f}){const b=()=>{const i=o||"";i.trim()&&!t&&(d(i.trim()),u&&u(""))},w=i=>{i.key==="Enter"&&!i.shiftKey&&(i.preventDefault(),b())},x=()=>{m&&m()},p=()=>{E&&E()};return s.jsxs("div",{className:"chat-wrapper__input",children:[s.jsx("textarea",{value:o||"",onChange:i=>u?u(i.target.value):void 0,onKeyPress:w,placeholder:n,disabled:t,className:"chat-wrapper__textarea",rows:1}),s.jsxs("div",{className:"chat-wrapper__input-buttons",children:[_&&s.jsx("button",{onClick:x,className:"chat-wrapper__stop-button",title:"Stop generation",children:"Stop"}),f&&!t&&s.jsx("button",{onClick:p,className:"chat-wrapper__clear-button",title:"Clear chat",children:"Clear"}),s.jsx("button",{onClick:b,disabled:t||!(o!=null&&o.trim()),className:"chat-wrapper__send-button",children:t?"Sending...":"Send"})]})]})}function de({apiUrl:d,config:t,tools:n,initialMessages:o=[]}){const[u,m]=r.useState(o),[E,_]=r.useState(""),[f,b]=r.useState(!1),[w,x]=r.useState(null),[p,i]=r.useState(!1),[B,v]=r.useState([]),[y,R]=r.useState([]),[g,L]=r.useState([]),[W,z]=r.useState([]),[A,C]=r.useState(""),[Z,T]=r.useState(!1),[F,M]=r.useState(""),J=r.useRef(null),H=r.useRef(null),$=r.useRef(null),I=r.useCallback(()=>Math.random().toString(36).substring(2)+Date.now().toString(36),[]),V=r.useCallback(()=>{var e;(e=J.current)==null||e.scrollIntoView({behavior:"smooth"})},[]);r.useEffect(()=>{n&&Object.keys(n).length>0&&console.log("Available tools:",Object.keys(n))},[n]),r.useEffect(()=>{V()},[u,V]),r.useEffect(()=>{t.onStreamingStatusChange&&t.onStreamingStatusChange(A)},[A,t]);const S=r.useCallback(e=>{const l=H.current;l&&m(j=>j.map(h=>h.id===l?e(h):h))},[]),q=r.useCallback(e=>{var l,j,h,O,c,k,N,P;switch(console.log("Processing stream event:",e.type,e),e.type){case"event":e.event==="latitude-event"?((l=e.data)==null?void 0:l.type)==="chain-started"?(C("Planning chain started"),T(!0),M("ðŸ”— Starting comprehensive planning chain...")):((j=e.data)==null?void 0:j.type)==="step-started"?(C("Planning step started"),T(!0),M("ðŸ“Š Executing planning step...")):((h=e.data)==null?void 0:h.type)==="provider-completed"?(C("AI planning completed"),T(!1),M(""),(O=e.data.response)!=null&&O.text&&S(a=>({...a,content:e.data.response.text,isStreaming:!1}))):((c=e.data)==null?void 0:c.type)==="chain-completed"&&(C("Planning completed"),T(!1),M(""),e.data.uuid&&x(e.data.uuid),S(a=>({...a,isStreaming:!1}))):e.event==="provider-event"&&((k=e.data)==null?void 0:k.type)==="text-delta"&&(T(!1),M(""),S(a=>({...a,content:a.content+e.data.textDelta})));break;case"text-delta":e.content&&S(a=>({...a,content:a.content+e.content}));break;case"tool-result":if(console.log("Tool result received:",e),e.tool&&e.data&&(e.data.id||e.data.success)){const a={id:e.data.id||I(),title:e.data.title||`${e.tool} result`,description:e.data.description,status:e.data.status||"completed",created_at:e.data.created_at||new Date().toISOString(),...e.data};v(D=>[...D,a])}e.todos&&(R(e.todos),t.onToolResult&&t.onToolResult("todos",e.todos)),e.briefs&&(L(e.briefs),t.onToolResult&&t.onToolResult("briefs",e.briefs));break;case"finished":C("Stream finished"),e.uuid&&x(e.uuid),(P=(N=e.result)==null?void 0:N.response)!=null&&P.text?S(a=>({...a,content:e.result.response.text,isStreaming:!1})):S(a=>({...a,isStreaming:!1}));break;case"stream-error":console.error("Stream error:",e.error),S(a=>({...a,content:`Stream Error: ${e.error}`,isStreaming:!1}));break;case"error":console.error("API error:",e.error),S(a=>({...a,content:`Error: ${e.error}`,isStreaming:!1}));break}},[S,I,t]),G=r.useCallback(async(e,l)=>{if(!e.trim()||f)return;const j={id:I(),role:"user",content:e.trim(),timestamp:new Date,media:l};m(c=>[...c,j]),b(!0),C("Starting...");const h=I();H.current=h;const O={id:h,role:"assistant",content:"",timestamp:new Date,isStreaming:!0};m(c=>[...c,O]);try{$.current=new AbortController;const c=t.endpoint==="brief-planner"?`${d}/api/brief-planner`:w?`${d}/api/conversation/${w}`:`${d}/api/conversation/init`,k=t.endpoint==="brief-planner"?{messages:[...u,j],promptPath:t.promptPath||"briefPlanner",conversationUuid:w,todos:y,briefs:g,media:l||[]}:{message:e.trim(),tools:n?Object.keys(n):[]};console.log("Sending request to:",c),console.log("Request payload:",JSON.stringify(k,null,2));const N=await fetch(c,{method:"POST",headers:{"Content-Type":"application/json",...t.apiKey&&{Authorization:`Bearer ${t.apiKey}`}},body:JSON.stringify(k),signal:$.current.signal});if(!N.ok)throw new Error(`HTTP error! status: ${N.status}`);await Q(N)}catch(c){c instanceof Error&&c.name==="AbortError"?console.log("Request aborted"):(console.error("Request error:",c),S(k=>({...k,content:`Sorry, there was an error: ${c instanceof Error?c.message:"Unknown error"}`,isStreaming:!1})),t.onError&&t.onError(c instanceof Error?c:new Error("Unknown error")))}finally{b(!1),C(""),T(!1),M(""),$.current=null,H.current=null}},[f,I,u,w,y,g,W,n,t,d,S,q]),Q=r.useCallback(async e=>{var O;const l=(O=e.body)==null?void 0:O.getReader(),j=new TextDecoder;if(!l)throw new Error("No response body reader available");let h="";for(;;){const{done:c,value:k}=await l.read();if(c){console.log("Stream completed");break}h+=j.decode(k,{stream:!0});const N=h.split(/\r?\n/);h=N.pop()||"";for(const P of N)if(P.startsWith("data: ")){const a=P.slice(6).trim();if(a==="[DONE]"||a==="")continue;try{const D=JSON.parse(a);q(D)}catch(D){console.error("Failed to parse event:",D)}}}},[q]),X=r.useCallback(()=>{$.current&&($.current.abort(),b(!1),C(""),T(!1),M(""))},[]),Y=r.useCallback(()=>{m(o),x(null),v([]),R([]),L([]),z([]),C(""),T(!1),M(""),console.log("Chat cleared")},[o]),ee=r.useCallback(()=>{i(!0)},[]),K=r.useCallback(()=>{i(!1)},[]);r.useEffect(()=>{const e=l=>{l.key==="Escape"&&t.mode==="modal"&&p&&K()};if(t.mode==="modal"&&p)return document.addEventListener("keydown",e),()=>document.removeEventListener("keydown",e)},[t.mode,p,K]);const te=((...e)=>e.filter(Boolean).join(" "))("chat-wrapper",`chat-wrapper--${t.mode}`,t.position&&`chat-wrapper--${t.position}`,t.theme&&`chat-wrapper--${t.theme}`),se=()=>t.mode==="modal"&&p?s.jsx("div",{className:"chat-wrapper-overlay",onClick:K}):null,re=()=>{var e;return t.mode==="modal"&&!p?s.jsxs("button",{className:"chat-wrapper__bubble-button",onClick:ee,title:`Open ${t.appName}`,children:[s.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",className:"chat-wrapper__bubble-icon",children:[s.jsx("path",{d:"M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z",fill:"currentColor"}),s.jsx("circle",{cx:"7",cy:"10",r:"1",fill:"currentColor"}),s.jsx("circle",{cx:"12",cy:"10",r:"1",fill:"currentColor"}),s.jsx("circle",{cx:"17",cy:"10",r:"1",fill:"currentColor"})]}),((e=t.features)==null?void 0:e.showBubbleText)!==!1&&s.jsx("span",{className:"chat-wrapper__bubble-text",children:t.bubbleText||"Chat"})]}):null},ae=()=>t.mode==="modal"&&p?s.jsx("button",{className:"chat-wrapper__close-button",onClick:K,title:"Close chat",children:s.jsx("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",xmlns:"http://www.w3.org/2000/svg",children:s.jsx("path",{d:"M19 6.41L17.59 5L12 10.59L6.41 5L5 6.41L10.59 12L5 17.59L6.41 19L12 13.41L17.59 19L19 17.59L13.41 12L19 6.41Z",fill:"currentColor"})})}):null,ne=()=>!Z||!F?null:s.jsx("div",{className:"chat-wrapper__thinking",children:s.jsxs("div",{className:"chat-wrapper__thinking-content",children:[s.jsx("span",{className:"chat-wrapper__thinking-spinner"}),s.jsx("span",{children:F})]})}),oe=()=>{var e;return!((e=t.features)!=null&&e.showToolResults)||B.length===0?null:s.jsxs("div",{className:"chat-wrapper__tool-results",children:[s.jsx("h4",{children:"Tool Results"}),s.jsx("div",{className:"chat-wrapper__tool-results-list",children:B.map(l=>s.jsxs("div",{className:"chat-wrapper__tool-result",children:[s.jsx("div",{className:"chat-wrapper__tool-result-title",children:l.title}),l.description&&s.jsx("div",{className:"chat-wrapper__tool-result-description",children:l.description}),s.jsxs("div",{className:"chat-wrapper__tool-result-meta",children:["Status: ",l.status||"completed"]})]},l.id))})]})};return t.mode==="modal"&&!p?re():s.jsxs(s.Fragment,{children:[se(),s.jsxs("div",{className:te,style:t.customStyles,children:[s.jsxs("div",{className:"chat-wrapper__header",children:[s.jsx("h2",{className:"chat-wrapper__title",children:t.appName}),ae(),A&&s.jsx("div",{className:"chat-wrapper__status",children:A})]}),ne(),s.jsxs("div",{className:"chat-wrapper__messages",children:[u.map(e=>s.jsxs("div",{className:`chat-wrapper__message chat-wrapper__message--${e.role}`,children:[s.jsxs("div",{className:"chat-wrapper__message-content",children:[e.content,e.isStreaming&&s.jsx("span",{className:"chat-wrapper__streaming-indicator",children:"..."})]}),s.jsx("div",{className:"chat-wrapper__message-timestamp",children:e.timestamp.toLocaleTimeString()})]},e.id)),s.jsx("div",{ref:J})]}),oe(),s.jsx(ce,{onSend:G,disabled:f,placeholder:t.placeholder||"Type a message...",value:E,onChange:_,onStop:X,onClear:Y,showStopButton:f,showClearButton:u.length>0}),t.onError&&s.jsx("div",{className:"chat-wrapper__error-boundary"})]})]})}class ue{constructor(t,n){U(this,"baseUrl");U(this,"apiKey");this.baseUrl=t,this.apiKey=n}getHeaders(){const t={"Content-Type":"application/json"};return this.apiKey&&(t.Authorization=`Bearer ${this.apiKey}`),t}async initConversation(){const t=await fetch(`${this.baseUrl}/api/conversation/init`,{method:"POST",headers:this.getHeaders()});if(!t.ok)throw new Error("Failed to initialize conversation");return(await t.json()).conversationId}async*streamMessage(t,n){const o=await fetch(`${this.baseUrl}/api/conversation/${t}`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({message:n})});if(!o.ok)throw new Error("Failed to send message");if(!o.body)throw new Error("No response body");const u=o.body.getReader(),m=new TextDecoder;for(;;){const{done:E,value:_}=await u.read();if(E)break;const b=m.decode(_).split(`
`);for(const w of b)if(w.startsWith("data: ")){const x=w.slice(6);if(x==="[DONE]")return;try{yield JSON.parse(x).content||""}catch(p){console.error("Failed to parse chunk:",p)}}}}}function pe(d,t){const[n,o]=r.useState([]),[u,m]=r.useState(!1),[E,_]=r.useState(null),f=r.useRef(null),b=r.useRef(new ue(d,t)),w=r.useCallback(async()=>{try{const i=await b.current.initConversation();return f.current=i,i}catch(i){throw _(i),i}},[]),x=r.useCallback(async i=>{f.current||await w();const B={id:Date.now().toString(),role:"user",content:i,timestamp:new Date};o(y=>[...y,B]),m(!0),_(null);const v={id:(Date.now()+1).toString(),role:"assistant",content:"",timestamp:new Date,isStreaming:!0};o(y=>[...y,v]);try{const y=b.current.streamMessage(f.current,i);for await(const R of y)o(g=>g.map(L=>L.id===v.id?{...L,content:L.content+R}:L));o(R=>R.map(g=>g.id===v.id?{...g,isStreaming:!1}:g))}catch(y){_(y),o(R=>R.filter(g=>g.id!==v.id))}finally{m(!1)}},[w]),p=r.useCallback(()=>{o([]),f.current=null},[]);return{messages:n,isLoading:u,error:E,sendMessage:x,clearMessages:p}}exports.ChatWrapper=de;exports.useChatConnection=pe;
